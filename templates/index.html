<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MBTA Station Finder</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        line-height: 1.6;
      }
      .form-group {
        margin-bottom: 20px;
        position: relative;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .input-wrapper {
        position: relative;
      }
      input[type="text"] {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      input[type="text"]:focus {
        border-color: #4CAF50;
        outline: none;
      }
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        background: white;
        border: 2px solid #4CAF50;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-top: -2px;
      }
      .autocomplete-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
      }
      .autocomplete-item:hover {
        background-color: #f5f5f5;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-item.highlighted {
        background-color: #e8f5e9;
      }
      .loading {
        padding: 12px;
        text-align: center;
        color: #666;
        font-style: italic;
      }
      .hint {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
        font-style: italic;
      }
      .examples {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin-top: 10px;
      }
      .examples h3 {
        margin-top: 0;
        font-size: 16px;
      }
      .examples ul {
        margin: 10px 0;
        padding-left: 20px;
      }
      button {
        background-color: #4CAF50;
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
      }
      button:hover {
        background-color: #45a049;
      }
      .error-message {
        color: #d32f2f;
        background-color: #ffebee;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
      }
    </style>
  </head>

  <body>
    <h1>MBTA Station Finder</h1>
    <p>Find the nearest MBTA station to any location in the Greater Boston area.</p>
    
    <div class="error-message" id="errorMessage"></div>
    
    <form action="/nearest_mbta" method="POST" id="searchForm" onsubmit="return validateForm()">
      <div class="form-group">
        <label for="place_name">Enter a place name or address:</label>
        <div class="input-wrapper">
          <input 
            type="text" 
            id="place_name" 
            name="place_name" 
            placeholder="Start typing a location..."
            required 
            minlength="2"
            autocomplete="off"
          />
          <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
        </div>
        <div class="hint">
          ðŸ’¡ Tip: Start typing and select from suggestions, or enter a landmark, building name, street address, or neighborhood
        </div>
      </div>
      
      <div class="examples">
        <h3>Examples of what you can search for:</h3>
        <ul>
          <li><strong>Landmarks:</strong> "Boston Common", "Fenway Park", "Harvard Square"</li>
          <li><strong>Addresses:</strong> "123 Main St, Boston, MA", "Beacon Street, Boston"</li>
          <li><strong>Neighborhoods:</strong> "Back Bay", "North End", "Cambridge"</li>
          <li><strong>Buildings:</strong> "TD Garden", "Boston Public Library"</li>
        </ul>
      </div>
      
      <button type="submit">Find Nearest MBTA Station</button>
    </form>

    <script>
      let autocompleteTimeout;
      let selectedIndex = -1;
      let suggestions = [];

      const input = document.getElementById('place_name');
      const dropdown = document.getElementById('autocompleteDropdown');
      const errorDiv = document.getElementById('errorMessage');

      // Autocomplete functionality
      input.addEventListener('input', function() {
        const value = this.value.trim();
        
        // Clear error when user starts typing
        errorDiv.style.display = 'none';
        
        // Hide dropdown if input is too short
        if (value.length < 2) {
          hideDropdown();
          return;
        }
        
        // Debounce API calls
        clearTimeout(autocompleteTimeout);
        autocompleteTimeout = setTimeout(() => {
          console.log('Fetching suggestions for:', value);
          fetchSuggestions(value);
        }, 300); // Wait 300ms after user stops typing
      });
      
      // Also trigger on focus if there's text
      input.addEventListener('focus', function() {
        const value = this.value.trim();
        if (value.length >= 2) {
          fetchSuggestions(value);
        }
      });

      // Handle keyboard navigation
      input.addEventListener('keydown', function(e) {
        if (dropdown.style.display === 'none' || suggestions.length === 0) {
          return;
        }

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
          updateHighlight();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateHighlight();
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          selectSuggestion(suggestions[selectedIndex]);
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          hideDropdown();
        }
      });

      function fetchSuggestions(query) {
        if (!query || query.length < 2) {
          hideDropdown();
          return;
        }
        
        fetch(`/autocomplete?q=${encodeURIComponent(query)}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Suggestions received:', data);
            suggestions = data;
            displaySuggestions(data);
          })
          .catch(error => {
            console.error('Error fetching suggestions:', error);
            hideDropdown();
          });
      }

      function displaySuggestions(suggestions) {
        if (!suggestions || suggestions.length === 0) {
          hideDropdown();
          return;
        }

        dropdown.innerHTML = '';
        selectedIndex = -1;

        suggestions.forEach((suggestion, index) => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = suggestion.text || suggestion.value || '';
          item.addEventListener('click', () => selectSuggestion(suggestion));
          item.addEventListener('mouseenter', () => {
            selectedIndex = index;
            updateHighlight();
          });
          dropdown.appendChild(item);
        });

        dropdown.style.display = 'block';
        console.log('Dropdown displayed with', suggestions.length, 'items');
      }

      function updateHighlight() {
        const items = dropdown.querySelectorAll('.autocomplete-item');
        items.forEach((item, index) => {
          if (index === selectedIndex) {
            item.classList.add('highlighted');
            item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          } else {
            item.classList.remove('highlighted');
          }
        });
      }

      function selectSuggestion(suggestion) {
        input.value = suggestion.text;
        hideDropdown();
        input.focus();
      }

      function hideDropdown() {
        dropdown.style.display = 'none';
        suggestions = [];
        selectedIndex = -1;
      }

      function validateForm() {
        const value = input.value.trim();
        
        // Clear previous errors
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        
        // Check if input is too short
        if (value.length < 2) {
          showError('Please enter at least 2 characters.');
          return false;
        }
        
        // Check for only special characters or numbers
        if (/^[^a-zA-Z]+$/.test(value)) {
          showError('Please enter a valid place name or address (include letters).');
          return false;
        }
        
        return true;
      }
      
      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        return false;
      }
    </script>
  </body>
</html>
